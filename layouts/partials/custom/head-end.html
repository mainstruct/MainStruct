<script>
/* Topbar Language & Theme — robust version
 * - 语言下拉：放搜索右侧，桌面端显示，移动端隐藏；依据 <link rel="alternate"> 或路径前缀互跳
 * - 顶部主题按钮：自带图标渲染，始终与当前主题同步；点击转发给原按钮以沿用主题的持久化逻辑
 */
document.addEventListener('DOMContentLoaded', function () {
  const anchor = document.querySelector('.hextra-search-wrapper') ||
                 document.querySelector('.hextra-nav-container');
  if (!anchor) return;

  /* ---------- Language select ---------- */
  function readAlternates() {
    const m = new Map();
    document.querySelectorAll('link[rel="alternate"][hreflang]').forEach(l=>{
      const lang=(l.getAttribute('hreflang')||'').toLowerCase();
      const href=l.getAttribute('href'); if(lang && href) m.set(lang, href);
    });
    return m;
  }
  function currentLang() {
    const htmlLang=(document.documentElement.lang||'').toLowerCase();
    if (htmlLang) return htmlLang;
    const p=location.pathname.toLowerCase();
    if (p.startsWith('/zh-cn/')) return 'zh-cn';
    if (p.startsWith('/en/'))    return 'en';
    return 'en';
  }
  function switchURL(target) {
    const alts = readAlternates();
    if (alts.size && alts.get(target)) return alts.get(target);
    const u = new URL(location.href), p=u.pathname;
    if (target==='zh-cn') {
      if (p.startsWith('/en/')) u.pathname=p.replace(/^\/en\//,'/zh-cn/');
      else if (!p.startsWith('/zh-cn/')) u.pathname='/zh-cn'+(p.startsWith('/')?p:'/'+p);
    } else {
      if (p.startsWith('/zh-cn/')) u.pathname=p.replace(/^\/zh-cn\//,'/en/');
      else if (!p.startsWith('/en/'))    u.pathname='/en'+(p.startsWith('/')?p:'/'+p);
    }
    return u.toString();
  }

  const labels={ 'en':'English', 'zh-cn':'简体中文' };
  const langs=['en','zh-cn'];
  const cur=currentLang();

  const langSelect=document.createElement('select');
  langSelect.className='hx-navbar-lang';
  langs.forEach(code=>{
    const opt=document.createElement('option');
    opt.value=switchURL(code);
    opt.textContent=labels[code]||code;
    if(code===cur) opt.selected=true;
    langSelect.appendChild(opt);
  });
  langSelect.addEventListener('change', e => { const url=e.target.value; if(url) location.href=url; });
  anchor.insertAdjacentElement('afterend', langSelect);

  /* ---------- Theme toggle (own icon, synced) ---------- */
  const origTheme = document.querySelector('.hextra-theme-toggle'); // 原主题按钮（留在原位）
  const topTheme  = document.createElement('button');
  topTheme.type   = 'button';
  topTheme.className = 'hextra-theme-toggle in-navbar hx-top-theme';
  langSelect.insertAdjacentElement('afterend', topTheme);

  function isDark(){
    // 主题通常通过 html.dark 或 data-theme=dark 控制
    return document.documentElement.classList.contains('dark') ||
           (document.documentElement.getAttribute('data-theme')||'').toLowerCase()==='dark';
  }
  function renderThemeIcon(){
    if (isDark()){
      topTheme.setAttribute('aria-label','Light');
      topTheme.title='Light';
      // moon -> sun 图标（暗色时显示“太阳”，点击回到亮色）
      topTheme.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 4V2M12 22v-2M4.93 4.93 3.51 3.51M20.49 20.49l-1.42-1.42M4 12H2M22 12h-2M4.93 19.07l-1.42 1.42M20.49 3.51l-1.42 1.42M12 8a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
    } else {
      topTheme.setAttribute('aria-label','Dark');
      topTheme.title='Dark';
      // sun -> moon 图标（亮色时显示“月亮”，点击进入暗色）
      topTheme.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
    }
  }
  function toggleTheme(){
    if (origTheme) {
      // 用主题自带的逻辑切换（含持久化）
      origTheme.click();
    } else {
      // 极端兜底：没人处理就直接切 html.dark
      document.documentElement.classList.toggle('dark');
      try { localStorage.setItem('theme', isDark() ? 'dark' : 'light'); } catch(e){}
    }
    // 等主题脚本完成，再刷新图标
    requestAnimationFrame(()=>setTimeout(renderThemeIcon,0));
  }
topTheme.addEventListener('click', toggleTheme);

  // 初始渲染 + 监控变化（跨页/跨标签也同步）
  renderThemeIcon();
  const obs = new MutationObserver(renderThemeIcon);
  obs.observe(document.documentElement, {attributes:true, attributeFilter:['class','data-theme']});
  if (origTheme) obs.observe(origTheme, {attributes:true, childList:true, subtree:true});
  window.addEventListener('storage', (e)=>{ if ((e.key||'').toLowerCase().includes('theme')) renderThemeIcon(); });

  /* ---------- Styles ---------- */
  const style=document.createElement('style');
  style.textContent=`
    @media (min-width:1024px){
      select.hx-navbar-lang{
        width:auto; max-width:14rem; height:2rem;
        padding:0 .55rem; border-radius:9999px;
        border:1px solid var(--hx-border, rgba(0,0,0,.14));
        background:transparent; color:var(--hx-fg, inherit);
        font-size:.9rem; line-height:2rem; cursor:pointer; margin-left:.5rem;
        color-scheme: light dark;
      }
      html.dark select.hx-navbar-lang{
        color: rgba(255,255,255,.92);
        border-color: rgba(255,255,255,.22);
        background-color: rgba(255,255,255,.06);
      }
      html.dark select.hx-navbar-lang option{ color:#111; background:#fff; }

      .hextra-theme-toggle.in-navbar{ margin-left:.5rem; background:transparent; border:0; padding:0 .25rem; }
      .hextra-theme-toggle.in-navbar svg{ display:block; }

      /* 新增：桌面端隐藏原位置的日/夜切换按钮（保留顶部的） */
      .hextra-theme-toggle:not(.in-navbar){ display: none !important; }

      /* 桌面端也隐藏原位置的语言切换器，避免重复 */
      .hextra-language-switcher{ display:none !important; }
    }
    @media (max-width:1023.98px){
      /* 移动端：顶部语言下拉不显示；底部的日/夜按钮继续保留 */
      select.hx-navbar-lang{ display:none !important; }
    }
  `;
  document.head.appendChild(style);

});
</script>
